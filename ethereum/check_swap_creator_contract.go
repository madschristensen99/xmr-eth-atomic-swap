// Copyright 2023 The AthanorLabs/atomic-swap Authors
// SPDX-License-Identifier: LGPL-3.0-only

package contracts

import (
	"bytes"
	"context"
	"errors"
	"fmt"

	ethcommon "github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/ethclient"
)

// expectedSwapCreatorBytecodeHex is generated by deploying an instance of
// SwapCreator.sol and reading back the bytecode. See the unit test
// TestExpectedSwapCreatorBytecodeHex if you need to update this value.
const (
	expectedSwapCreatorBytecodeHex = "0x60806040526004361061006e575f3560e01c8063b32d1b4f1161004c578063b32d1b4f146100d1578063c41e46cf14610105578063eb84e7f214610126578063fcaf229c14610161575f5ffd5b80631e6c5acc146100725780635cb969161461009357806387065c49146100b2575b5f5ffd5b34801561007d575f5ffd5b5061009161008c366004610e83565b610180565b005b34801561009e575f5ffd5b506100916100ad366004610e83565b610362565b3480156100bd575f5ffd5b506100916100cc366004610ed1565b610425565b3480156100dc575f5ffd5b506100f06100eb366004610f8a565b610688565b60405190151581526020015b60405180910390f35b610118610113366004610faa565b610754565b6040519081526020016100fc565b348015610131575f5ffd5b50610154610140366004611016565b5f6020819052908152604090205460ff1681565b6040516100fc9190611041565b34801561016c575f5ffd5b5061009161017b366004611067565b6109cc565b5f8260405160200161019291906110ef565b60408051601f1981840301815291815281516020928301205f818152928390529082205490925060ff16908160038111156101cf576101cf61102d565b036101ed57604051631115766760e01b815260040160405180910390fd5b60038160038111156102015761020161102d565b0361021f5760405163066916a960e01b815260040160405180910390fd5b83516001600160a01b031633146102495760405163148ca24360e11b815260040160405180910390fd5b8360a001514210801561027a5750836080015142118061027a575060028160038111156102785761027861102d565b145b15610298576040516332a1860f60e11b815260040160405180910390fd5b6102a6838560600151610aa7565b604051839083907e7c875846b687732a7579c19bb1dade66cd14e9f4f809565e2b2b5e76c72b4f905f90a35f828152602081905260409020805460ff1916600317905560c08401516001600160a01b031661033b57835160e08501516040516001600160a01b039092169181156108fc0291905f818181858888f19350505050158015610335573d5f5f3e3d5ffd5b5061035c565b835160e085015160c086015161035c926001600160a01b0390911691610ace565b50505050565b81602001516001600160a01b0316336001600160a01b03161461039857604051633471640960e11b815260040160405180910390fd5b6103a28282610b08565b60c08201516001600160a01b03166103f75781602001516001600160a01b03166108fc8360e0015190811502906040515f60405180830381858888f193505050501580156103f2573d5f5f3e3d5ffd5b505050565b61042182602001518360e001518460c001516001600160a01b0316610ace9092919063ffffffff16565b5050565b5f60018860405160200161043991906110fe565b60408051601f1981840301815282825280516020918201205f84529083018083525260ff871690820152606081018590526080810184905260a0016020604051602081039080840390855afa158015610494573d5f5f3e3d5ffd5b505050602060405103519050875f0151602001516001600160a01b0316816001600160a01b0316146104d957604051638baa579f60e01b815260040160405180910390fd5b87606001516001600160a01b0316306001600160a01b03161461050f5760405163a710429d60e01b815260040160405180910390fd5b60408089015190516bffffffffffffffffffffffff19606089901b1660208201526001600160e01b031960e088901b166034820152603801604051602081830303815290604052805190602001201461057b5760405163fe16c3c560e01b815260040160405180910390fd5b87516105879088610b08565b875160c001516001600160a01b031661062757875f0151602001516001600160a01b03166108fc89602001518a5f015160e001516105c59190611154565b6040518115909202915f818181858888f193505050501580156105ea573d5f5f3e3d5ffd5b5060208801516040516001600160a01b0388169180156108fc02915f818181858888f19350505050158015610621573d5f5f3e3d5ffd5b5061067e565b8751602080820151908a015160e09092015161065c9261064691611154565b8a5160c001516001600160a01b03169190610ace565b6020880151885160c0015161067e916001600160a01b03909116908890610ace565b5050505050505050565b5f80600181601b7f79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f8179870014551231950b75fc4402da1732fc9bebe197f79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f817988909604080515f8152602081018083529590955260ff909316928401929092526060830152608082015260a0016020604051602081039080840390855afa158015610731573d5f5f3e3d5ffd5b5050604051601f1901516001600160a01b03858116911614925050505b92915050565b5f825f0361077557604051637c946ed760e01b815260040160405180910390fd5b6001600160a01b0384166107a8573483146107a357604051632a9ffab760e21b815260040160405180910390fd5b6107bd565b6107bd6001600160a01b038516333086610c65565b8815806107c8575087155b156107e657604051631bc61bed60e11b815260040160405180910390fd5b6001600160a01b03871661080c576040516208978560e71b815260040160405180910390fd5b851580610817575084155b1561083557604051631ffb86f160e21b815260040160405180910390fd5b5f604051806101200160405280336001600160a01b03168152602001896001600160a01b031681526020018b81526020018a815260200188426108789190611167565b8152602001876108888a42611167565b6108929190611167565b8152602001866001600160a01b031681526020018581526020018481525090505f816040516020016108c491906110ef565b60408051601f19818403018152919052805160209091012090505f5f8281526020819052604090205460ff1660038111156109015761090161102d565b1461091f576040516339a2986760e11b815260040160405180910390fd5b7f91446ce035ac29998b5473504609a5ef5e961005daba4630a1684b63be848f56818c8c85608001518660a001518760c001518860e0015160405161099e979695949392919096875260208701959095526040860193909352606085019190915260808401526001600160a01b031660a083015260c082015260e00190565b60405180910390a15f818152602081905260409020805460ff191660011790559a9950505050505050505050565b5f816040516020016109de91906110ef565b60408051601f198184030181529190528051602090910120905060015f8281526020819052604090205460ff166003811115610a1c57610a1c61102d565b14610a3a57604051630fe0fb5160e11b815260040160405180910390fd5b81516001600160a01b03163314610a645760405163148ca24360e11b815260040160405180910390fd5b5f81815260208190526040808220805460ff191660021790555182917f5fc23b25552757626e08b316cc2387ad1bc70ee1594af7204db4ce0c39f5d15f91a25050565b610ab18282610688565b6104215760405163abab6bd760e01b815260040160405180910390fd5b610adb8383836001610c9b565b6103f257604051635274afe760e01b81526001600160a01b03841660048201526024015b60405180910390fd5b5f82604051602001610b1a91906110ef565b60408051601f1981840301815291815281516020928301205f818152928390529082205490925060ff1690816003811115610b5757610b5761102d565b03610b7557604051631115766760e01b815260040160405180910390fd5b6003816003811115610b8957610b8961102d565b03610ba75760405163066916a960e01b815260040160405180910390fd5b836080015142108015610bcc57506002816003811115610bc957610bc961102d565b14155b15610bea5760405163d71d60b560e01b815260040160405180910390fd5b8360a001514210610c0e5760405163497df9d160e01b815260040160405180910390fd5b610c1c838560400151610aa7565b604051839083907f38d6042dbdae8e73a7f6afbabd3fbe0873f9f5ed3cd71294591c3908c2e65fee905f90a3505f908152602081905260409020805460ff191660031790555050565b610c73848484846001610cfd565b61035c57604051635274afe760e01b81526001600160a01b0385166004820152602401610aff565b60405163a9059cbb60e01b5f8181526001600160a01b038616600452602485905291602083604481808b5af1925060015f51148316610cf1578383151615610ce5573d5f823e3d81fd5b5f873b113d1516831692505b60405250949350505050565b6040516323b872dd60e01b5f8181526001600160a01b038781166004528616602452604485905291602083606481808c5af1925060015f51148316610d59578383151615610d4d573d5f823e3d81fd5b5f883b113d1516831692505b604052505f60605295945050505050565b604051610120810167ffffffffffffffff81118282101715610d9a57634e487b7160e01b5f52604160045260245ffd5b60405290565b6040516080810167ffffffffffffffff81118282101715610d9a57634e487b7160e01b5f52604160045260245ffd5b6001600160a01b0381168114610de3575f5ffd5b50565b8035610df181610dcf565b919050565b5f6101208284031215610e07575f5ffd5b610e0f610d6a565b9050610e1a82610de6565b8152610e2860208301610de6565b602082015260408281013590820152606080830135908201526080808301359082015260a08083013590820152610e6160c08301610de6565b60c082015260e082810135908201526101009182013591810191909152919050565b5f5f6101408385031215610e95575f5ffd5b610e9f8484610df6565b94610120939093013593505050565b803563ffffffff81168114610df1575f5ffd5b803560ff81168114610df1575f5ffd5b5f5f5f5f5f5f5f878903610240811215610ee9575f5ffd5b610180811215610ef7575f5ffd5b50610f00610da0565b610f0a8a8a610df6565b815261012089013560208201526101408901356040820152610160890135610f3181610dcf565b606082015296506101808801359550610f4d6101a08901610de6565b9450610f5c6101c08901610eae565b9350610f6b6101e08901610ec1565b9699959850939692959461020084013594506102209093013592915050565b5f5f60408385031215610f9b575f5ffd5b50508035926020909101359150565b5f5f5f5f5f5f5f5f610100898b031215610fc2575f5ffd5b88359750602089013596506040890135610fdb81610dcf565b9550606089013594506080890135935060a0890135610ff981610dcf565b979a969950949793969295929450505060c08201359160e0013590565b5f60208284031215611026575f5ffd5b5035919050565b634e487b7160e01b5f52602160045260245ffd5b602081016004831061106157634e487b7160e01b5f52602160045260245ffd5b91905290565b5f6101208284031215611078575f5ffd5b6110828383610df6565b9392505050565b80516001600160a01b03908116835260208083015182169084015260408083015190840152606080830151908401526080808301519084015260a0808301519084015260c0808301519091169083015260e0808201519083015261010090810151910152565b610120810161074e8284611089565b5f61018082019050611111828451611089565b602083015161012083015260408301516101408301526060909201516001600160a01b03166101609091015290565b634e487b7160e01b5f52601160045260245ffd5b8181038181111561074e5761074e611140565b8082018082111561074e5761074e61114056fea264697066735822122041ad133cb95dfa59c0c4a0c420fcf1e8ecf3d9399d9c0efcb8c2b95dec03b6e564736f6c634300081c0033" //nolint:lll
)

var (
	errInvalidSwapCreatorContract = errors.New("given contract address does not contain correct SwapCreator code")
)

// CheckSwapCreatorContractCode checks that the bytecode at the given address
// matches the SwapCreator.sol contract.
func CheckSwapCreatorContractCode(
	ctx context.Context,
	ec *ethclient.Client,
	contractAddr ethcommon.Address,
) error {
	code, err := ec.CodeAt(ctx, contractAddr, nil)
	if err != nil {
		return fmt.Errorf("failed to get code at %s: %w", contractAddr, err)
	}

	expectedCode := ethcommon.FromHex(expectedSwapCreatorBytecodeHex)

	if len(code) != len(expectedCode) {
		return fmt.Errorf("length mismatch: %w", errInvalidSwapCreatorContract)
	}

	if !bytes.Equal(expectedCode, code) {
		return errInvalidSwapCreatorContract
	}

	return nil
}
