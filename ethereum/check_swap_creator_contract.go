// Copyright 2023 The AthanorLabs/atomic-swap Authors
// SPDX-License-Identifier: LGPL-3.0-only

package contracts

import (
	"bytes"
	"context"
	"errors"
	"fmt"

	ethcommon "github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/ethclient"
)

// expectedSwapCreatorBytecodeHex is generated by deploying an instance of
// SwapCreator.sol and reading back the bytecode. See the unit test
// TestExpectedSwapCreatorBytecodeHex if you need to update this value.
const (
	expectedSwapCreatorBytecodeHex = "0x6080604052600436101561001257600080fd5b60003560e01c80631e6c5acc146107735780635cb96916146106cd57806387065c4914610412578063b32d1b4f146103e7578063c41e46cf14610192578063eb84e7f21461015a5763fcaf229c1461006957600080fd5b3461015557610120366003190112610155576100843661094d565b604051602081019061009682846109e1565b61012081526100a76101408261092b565b5190209081600052600060205260ff60406000205416600481101561013f5760010361012e57516001600160a01b0316330361011d578060005260006020526040600020600260ff198254161790557f5fc23b25552757626e08b316cc2387ad1bc70ee1594af7204db4ce0c39f5d15f600080a2005b63148ca24360e11b60005260046000fd5b630fe0fb5160e11b60005260046000fd5b634e487b7160e01b600052602160045260246000fd5b600080fd5b3461015557602036600319011261015557600435600052600060205260ff60406000205416604051600482101561013f576020918152f35b610100366003190112610155576024356004356044356001600160a01b03811690819003610155576064356084359260a4359460018060a01b0386168096036101555760c4359485156103d6578661039757348603610386575b8215801561037e575b61036d57841561035d5783158015610355575b610344576102299061022461021d8642610aff565b9542610aff565b610aff565b93604051906102378261090e565b33825260208201528260408201528160608201526080810193845260a0810194855260c0810196875260e0810195865260e4356101008201526040516102816020820180936109e1565b61012081526102926101408261092b565b5190209485600052600060205260ff60406000205416600481101561013f57610333576020967f91446ce035ac29998b5473504609a5ef5e961005daba4630a1684b63be848f569560e0955190519160018060a01b03905116925193604051958987528a87015260408601526060850152608084015260a083015260c0820152a180600052600082526040600020600160ff19825416179055604051908152f35b6339a2986760e11b60005260046000fd5b631ffb86f160e21b60005260046000fd5b508015610208565b6208978560e71b60005260046000fd5b631bc61bed60e11b60005260046000fd5b5081156101f5565b632a9ffab760e21b60005260046000fd5b6103d16040516323b872dd60e01b6020820152336024820152306044820152876064820152606481526103cb60848261092b565b88610c71565b6101ec565b637c946ed760e01b60005260046000fd5b34610155576040366003190112610155576020610408602435600435610a6a565b6040519015158152f35b3461015557366003190161024081126101555761018013610155576040516080810181811067ffffffffffffffff8211176106b7576040526104533661094d565b80825261012435602083019081526101443560408401908152610164359391926001600160a01b038516850361015557606083019485526101a4356001600160a01b03811695909190868303610155576101c4359163ffffffff83168303610155576101e43560ff81168091036101555760806000916020936040516104dc86820180936109e1565b8b51610140820152895161016082015286516001600160a01b031661018080830191909152815261050f6101a08261092b565b519020906040519182528482015261020435604082015261022435606082015282805260015afa15610621576000518551602001516001600160a01b039081169116036106a657516001600160a01b03163003610695576040519060208201926bffffffffffffffffffffffff199060601b16835263ffffffff60e01b9060e01b166034820152601881526105a560388261092b565b519020905103610684576105bd610184358251610b70565b805160c08101516001600160a01b0316908161063f575050600080808093516105f960e060018060a01b03602084015116920151875190610a47565b90828215610636575bf1156106215760008080938193519082821561062d575bf11561062157005b6040513d6000823e3d90fd5b506108fc610619565b506108fc610602565b61068294929161066c9161066660e060018060a01b03602084015116920151875190610a47565b91610b2e565b5160c001519151916001600160a01b0316610b2e565b005b63fe16c3c560e01b60005260046000fd5b63a710429d60e01b60005260046000fd5b638baa579f60e01b60005260046000fd5b634e487b7160e01b600052604160045260246000fd5b3461015557610140366003190112610155576106e83661094d565b6020810180516001600160a01b031633036107625761070a6101243583610b70565b60c08201516001600160a01b03168061074757505160e090910151600091829182918291906001600160a01b031682821561062d57f11561062157005b909160e06106829360018060a01b0390511691015191610b2e565b633471640960e11b60005260046000fd5b34610155576101403660031901126101555761078e3661094d565b6101243560405160208101906107a482856109e1565b61012081526107b56101408261092b565b5190209081600052600060205260ff60406000205416600481101561013f5780156108fd576000600382146108ee5784516001600160a01b031633036108df5760a0850151421091826108b8575b50506108a757610817606084015182610b0c565b817e7c875846b687732a7579c19bb1dade66cd14e9f4f809565e2b2b5e76c72b4f600080a36000908152602081905260409020805460ff1916600317905560c08101516001600160a01b03168061088e575060008080809360e060018060a01b038251169101519082821561062d57f11561062157005b6106829160e060018060a01b0382511691015191610b2e565b6332a1860f60e11b60005260046000fd5b6080860151421192509082156108d2575b50508480610803565b60029250501484806108c9565b63148ca24360e11b8152600490fd5b63066916a960e01b8152600490fd5b631115766760e01b60005260046000fd5b610120810190811067ffffffffffffffff8211176106b757604052565b90601f8019910116810190811067ffffffffffffffff8211176106b757604052565b61012090600319011261015557604051906109678261090e565b816004356001600160a01b03811681036101555781526024356001600160a01b038116810361015557602082015260443560408201526064356060820152608435608082015260a43560a082015260c4356001600160a01b03811681036101555760c082015260e43560e082015261010061010435910152565b80516001600160a01b03908116835260208083015182169084015260408083015190840152606080830151908401526080808301519084015260a0808301519084015260c0808301519091169083015260e0808201519083015261010090810151910152565b91908203918211610a5457565b634e487b7160e01b600052601160045260246000fd5b6000608060209260405190838252601b858301527f79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f8179860408301527f79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f8179870014551231950b75fc4402da1732fc9bebe199109606082015282805260015afa15610621576000516001600160a01b0391821691161490565b91908201809211610a5457565b90610b1691610a6a565b15610b1d57565b63abab6bd760e01b60005260046000fd5b60405163a9059cbb60e01b60208201526001600160a01b039092166024830152604480830193909352918152610b6e91610b6960648361092b565b610c71565b565b906040516020810190610b8382856109e1565b6101208152610b946101408261092b565b5190209182600052600060205260ff60406000205416600481101561013f5780156108fd5760009060038114610c6257608083015142109182610c54575b5050610c435760a0810151421015610c32576040610bf291015182610b0c565b817f38d6042dbdae8e73a7f6afbabd3fbe0873f9f5ed3cd71294591c3908c2e65fee600080a360005260006020526040600020600360ff19825416179055565b63497df9d160e01b60005260046000fd5b63d71d60b560e01b60005260046000fd5b600292505014153880610bd2565b63066916a960e01b8252600482fd5b906000602091828151910182855af115610621576000513d610cc357506001600160a01b0381163b155b610ca25750565b635274afe760e01b60009081526001600160a01b0391909116600452602490fd5b60011415610c9b56fea2646970667358221220bc2e9c0d74a3da367b6f8f739564af1d48219726b8e06e1ecee7ec90a0f6108e64736f6c634300081e0033" //nolint:lll
)

var (
	errInvalidSwapCreatorContract = errors.New("given contract address does not contain correct SwapCreator code")
)

// CheckSwapCreatorContractCode checks that the bytecode at the given address
// matches the SwapCreator.sol contract.
func CheckSwapCreatorContractCode(
	ctx context.Context,
	ec *ethclient.Client,
	contractAddr ethcommon.Address,
) error {
	code, err := ec.CodeAt(ctx, contractAddr, nil)
	if err != nil {
		return fmt.Errorf("failed to get code at %s: %w", contractAddr, err)
	}

	expectedCode := ethcommon.FromHex(expectedSwapCreatorBytecodeHex)

	if len(code) != len(expectedCode) {
		return fmt.Errorf("length mismatch: %w", errInvalidSwapCreatorContract)
	}

	if !bytes.Equal(expectedCode, code) {
		return errInvalidSwapCreatorContract
	}

	return nil
}
